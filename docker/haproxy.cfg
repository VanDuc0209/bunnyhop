global
    daemon
    maxconn 4096
    log stdout format raw local0 info

defaults
    mode tcp
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    log global

# RabbitMQ AMQP Load Balancer
listen rabbitmq_amqp
    bind *:5670
    mode tcp
    balance roundrobin
    option tcp-check
    tcp-check connect
    tcp-check expect string "AMQP"
    server rabbitmq1 rabbitmq1:5672 check inter 5s rise 2 fall 3
    server rabbitmq2 rabbitmq2:5672 check inter 5s rise 2 fall 3
    server rabbitmq3 rabbitmq3:5672 check inter 5s rise 2 fall 3

# RabbitMQ Management UI Load Balancer
listen rabbitmq_management
    bind *:15670
    mode tcp
    balance roundrobin
    option tcp-check
    tcp-check connect
    tcp-check expect string "HTTP"
    server rabbitmq1 rabbitmq1:15672 check inter 5s rise 2 fall 3
    server rabbitmq2 rabbitmq2:15672 check inter 5s rise 2 fall 3
    server rabbitmq3 rabbitmq3:15672 check inter 5s rise 2 fall 3

# HAProxy Stats
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:admin123 